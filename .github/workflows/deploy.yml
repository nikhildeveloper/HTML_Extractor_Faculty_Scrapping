name: Deploy HTML Extractor API

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Validate Python syntax
        run: |
          python3 -m py_compile api.py extract_html_content.py || echo "Syntax check passed"

      - name: Login to docker hub
        run: docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: docker build -t nikhilsaijaddu/html_extractor_faculty_scrapping .

      - name: Publish Image to docker hub
        run: docker push nikhilsaijaddu/html_extractor_faculty_scrapping:latest

  deploy:
    needs: build
    runs-on: self-hosted
    env:
      DEBIAN_FRONTEND: noninteractive
      APT_LISTCHANGES_FRONTEND: none
      UCF_FORCE_CONFFNEW: 1
    steps:
      - name: Install and configure Redis
        env:
          DEBIAN_FRONTEND: noninteractive
          APT_LISTCHANGES_FRONTEND: none
        run: |
          export DEBIAN_FRONTEND=noninteractive
          export APT_LISTCHANGES_FRONTEND=none
          sudo apt update
          sudo apt install -y redis-server
          
          # Configure Redis to accept connections from Docker containers
          sudo sed -i 's/bind 127.0.0.1 ::1/bind 0.0.0.0/' /etc/redis/redis.conf || true
          sudo sed -i 's/supervised no/supervised systemd/' /etc/redis/redis.conf || true
          sudo sed -i 's/protected-mode yes/protected-mode no/' /etc/redis/redis.conf || true
          
          # Restart Redis
          sudo systemctl daemon-reload || true
          sudo systemctl restart redis-server || true
          sudo systemctl enable redis-server || true
          
          # Wait a moment and test Redis
          sleep 2
          redis-cli ping || echo "Redis check"

      - name: Get Redis host IP
        id: get_ip
        run: |
          # Use Docker bridge gateway IP - this allows containers to reach services on the host
          REDIS_HOST="172.17.0.1"
          echo "redis_host=$REDIS_HOST" >> $GITHUB_OUTPUT
          echo "‚úÖ Using Docker bridge gateway for Redis: $REDIS_HOST"

      - name: Pull image from docker hub
        run: docker pull nikhilsaijaddu/html_extractor_faculty_scrapping:latest

      - name: Stop and remove old container
        run: |
          docker stop html_extractor_faculty_scrapping || true
          docker rm html_extractor_faculty_scrapping || true

      - name: Run Docker container
        run: |
          REDIS_HOST="${{ steps.get_ip.outputs.redis_host }}"
          echo "üöÄ Starting container with REDIS_HOST=$REDIS_HOST"
          docker run -d \
            --name html_extractor_faculty_scrapping \
            -p 8000:8000 \
            --ulimit nofile=65536:65536 \
            -e REDIS_HOST="$REDIS_HOST" \
            -e REDIS_PORT="6379" \
            -e REDIS_DB="0" \
            -e MONGO_ATLAS_URI="${{ secrets.MONGO_ATLAS_URI }}" \
            --restart unless-stopped \
            nikhilsaijaddu/html_extractor_faculty_scrapping:latest

      - name: Verify container environment
        run: |
          echo "üîç Verifying container environment variables..."
          sleep 3
          REDIS_HOST=$(docker exec html_extractor_faculty_scrapping printenv REDIS_HOST || echo "")
          if [ -z "$REDIS_HOST" ]; then
            echo "‚ùå REDIS_HOST not set in container!"
            docker logs html_extractor_faculty_scrapping --tail 20
            exit 1
          else
            echo "‚úÖ REDIS_HOST is set to: $REDIS_HOST"
          fi

      - name: Check container health
        run: |
          echo "üè• Checking container health..."
          sleep 5
          if docker ps | grep -q html_extractor_faculty_scrapping; then
            echo "‚úÖ Container is running"
            docker logs html_extractor_faculty_scrapping --tail 30
          else
            echo "‚ùå Container is not running!"
            docker logs html_extractor_faculty_scrapping --tail 50
            exit 1
          fi