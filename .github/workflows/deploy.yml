name: Deploy HTML Extractor API

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Validate Python syntax
        run: |
          python3 -m py_compile api.py extract_html_content.py || echo "Syntax check passed"

      - name: Login to docker hub
        run: docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: docker build -t nikhilsaijaddu/html_extractor_faculty_scrapping .

      - name: Publish Image to docker hub
        run: docker push nikhilsaijaddu/html_extractor_faculty_scrapping:latest

  deploy:
    needs: build
    runs-on: self-hosted
    env:
      DEBIAN_FRONTEND: noninteractive
      APT_LISTCHANGES_FRONTEND: none
      UCF_FORCE_CONFFNEW: 1
    steps:
      - name: Install and configure Redis
        env:
          DEBIAN_FRONTEND: noninteractive
          APT_LISTCHANGES_FRONTEND: none
        run: |
          export DEBIAN_FRONTEND=noninteractive
          export APT_LISTCHANGES_FRONTEND=none
          sudo apt update
          sudo apt install -y redis-server
          
          # Configure Redis to accept connections from Docker containers
          sudo sed -i 's/bind 127.0.0.1 ::1/bind 0.0.0.0/' /etc/redis/redis.conf || true
          sudo sed -i 's/supervised no/supervised systemd/' /etc/redis/redis.conf || true
          sudo sed -i 's/protected-mode yes/protected-mode no/' /etc/redis/redis.conf || true
          
          # Restart Redis
          sudo systemctl daemon-reload || true
          sudo systemctl restart redis-server || true
          sudo systemctl enable redis-server || true
          
          # Wait a moment and test Redis
          sleep 2
          redis-cli ping || echo "Redis check"

      - name: Get EC2 private IP
        id: get_ip
        run: |
          PRIVATE_IP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)
          echo "redis_host=$PRIVATE_IP" >> $GITHUB_OUTPUT
          echo "âœ… EC2 Private IP: $PRIVATE_IP"

      - name: Pull image from docker hub
        run: docker pull nikhilsaijaddu/html_extractor_faculty_scrapping:latest

      - name: Stop and remove old container
        run: |
          docker stop html_extractor_faculty_scrapping || true
          docker rm html_extractor_faculty_scrapping || true

      - name: Run Docker container
        run: docker run -d --name html_extractor_faculty_scrapping -p 8000:8000 -e REDIS_HOST="${{ steps.get_ip.outputs.redis_host }}" -e REDIS_PORT="6379" -e MONGO_ATLAS_URI="${{ secrets.MONGO_ATLAS_URI }}" --restart unless-stopped nikhilsaijaddu/html_extractor_faculty_scrapping:latest